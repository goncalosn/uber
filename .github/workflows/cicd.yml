name: CI/CD
on:
  push:
  pull_request:

jobs:
  build:
    uses: ./.github/workflows/build.yml
  test:
    needs: build
    if: ${{ always() && !cancelled() && needs.build.result == 'success' }}
    uses: ./.github/workflows/test.yml
  # JOB to run change detection
  changes:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ always() && !cancelled() && needs.test.result == 'success' }}
    # Set job outputs to values from filter step
    outputs:
      api: ${{ steps.filter.outputs.api }}
      site: ${{ steps.filter.outputs.site }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            api:
              - 'packages/api/**'
            site:
              - 'packages/site/**'
  deploy-site:
    needs: changes
    if: ${{ needs.changes.outputs.site == 'true' }}
    uses: ./.github/workflows/deploy-site.yml
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID}}
      VERCEL_SITE_PROJECT_ID: ${{ secrets.VERCEL_SITE_PROJECT_ID}}
  # e2e:
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Run Lighthouse on urls and validate with lighthouserc
  #       uses: treosh/lighthouse-ci-action@v7
  #       with:
  #         urls: |
  #           ${{ needs.deploy.outputs.preview-url }}
  #           ${{ needs.deploy.outputs.preview-url }}/some-other-path
  #         budgetPath: ./budget.json
  #         runs: 3
