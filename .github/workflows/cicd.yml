name: CI/CD
on:
  push:
  pull_request:

jobs:
  test:
    uses: ./.github/workflows/test.yml

  build:
    needs: test
    if: ${{ success() && !cancelled() && needs.test.result == 'success' }}
    uses: ./.github/workflows/build.yml
    secrets:
      MONGODB_CONNECTION_STRING: ${{ secrets.MONGODB_CONNECTION_STRING }}

  deploy-site:
    needs: build
    if: ${{ success() && !cancelled() && needs.build.result == 'success' }}
    uses: ./.github/workflows/deploy-site.yml
    secrets:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL}}

  deploy-api:
    needs: build
    if: ${{ success() && !cancelled() && needs.build.result == 'success' }}
    uses: ./.github/workflows/deploy-api.yml
    secrets:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL}}
      DOMAIN: ${{ secrets.DOMAIN }}
      CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
      MONGODB_CONNECTION_STRING: ${{ secrets.MONGODB_CONNECTION_STRING }}
      JWT_PRIVATE: ${{ secrets.JWT_PRIVATE }}
      JWT_PUBLIC: ${{ secrets.JWT_PUBLIC }}
